#!/usr/bin/env ruby

require 'bundler/setup'

$LOAD_PATH.unshift(File.expand_path('../lib', __dir__))
require 'web_counter_server'

def fibonacci(number)
  if number.zero?
    0
  elsif number == 1
    1
  else
    fibonacci(number - 2) + fibonacci(number - 1)
  end
end

Thread.new do
  loop do
    print "-- CPU Usage: #{`ps -A -o %cpu | awk '{s+=$1} END {print s "%"}'`.strip} --\r"
    sleep(0.5)
  end
end

counter = 0

WebCounterServer.start do |request, response|
  counter = 0 if request.headers['X-INIT-COUNTER']

  response.set_status(200)
  response.headers['Content-Type'] = 'text/plain'

  counter += 1

  response.set_body("#{counter}: #{fibonacci(counter)}\n")
end
