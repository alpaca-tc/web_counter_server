#!/usr/bin/env ruby

require 'benchmark'
require 'open-uri'

system('curl http://127.0.0.1:8080 --header X-INIT-COUNTER:1')

size = 30
m = Mutex.new
all_responses = []

result = Benchmark.measure {
  threads = size.times.map do
    Thread.new do
      response = OpenURI.open_uri('http://127.0.0.1:8080').read.strip
      puts response
      m.synchronize { all_responses << response }
    end
  end

  threads.each(&:join)
}

# 1~100の値が帰ってくるはず
puts <<~EOS
#{Benchmark::CAPTION}
#{result}

---

#{all_responses.uniq.size == size ? '成功' : '失敗'}

全てのレスポンス: #{all_responses}
EOS
